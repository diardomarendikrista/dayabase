name: Deploy dayabase-be

on:
  push:
    branches: [main]
    paths:
      - "dayabase-be/**"
      - ".github/workflows/deploy-be.yml"

jobs:
  deploy-be:
    runs-on: self-hosted # Pakai runner di EC2 , jangan lupa kalo mau hapus ini, service di EC2 juga dihapus

    steps:
      - name: Deploy Backend on Server
        run: |
          echo "Navigating to project directory..."
          cd /home/ec2-user/dayabase

          echo "Fetching latest code from main branch..."
          git fetch --all
          git reset --hard origin/main

          echo "Setting up backend in dayabase-be..."
          cd dayabase-be

          echo "Installing Node dependencies..."
          npm install

          echo "Reloading PM2 service: dayabase-be..."
          # Kembali ke direktori utama tempat ecosystem.config.js berada
          cd /home/ec2-user/dayabase 
          pm2 reload ecosystem.config.js --only dayabase-be

          echo "Deployment complete!"

      - name: Check PM2 Status After Deploy
        if: always()
        run: |
          echo "Checking PM2 status..."
          pm2 status
