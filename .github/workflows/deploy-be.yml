name: Deploy dayabase-be

on:
  push:
    branches: [main]
    paths:
      - "dayabase-be/**"
      - ".github/workflows/deploy-be.yml"

jobs:
  deploy-be:
    # Memberitahu GitHub untuk menjalankan pekerjaan ini di runner pribadi Anda
    runs-on: self-hosted

    steps:
      # Langkah ini sekarang hanya satu blok 'run' karena semua perintah
      # dieksekusi langsung di server Anda, bukan melalui SSH.
      - name: Deploy Backend on Server
        run: |
          echo "Navigating to project directory..."
          cd /home/ubuntu/dayabase  # Gunakan path absolut untuk keamanan

          echo "Fetching latest code from main branch..."
          git fetch --all
          git reset --hard origin/main

          echo "Setting up backend in dayabase-be..."
          cd dayabase-be

          echo "Installing Node dependencies..."
          npm install

          echo "Reloading PM2 service: dayabase-be..."
          # Kembali ke direktori utama tempat ecosystem.config.js berada
          cd /home/ubuntu/dayabase 
          pm2 reload ecosystem.config.js --only dayabase-be

          echo "Deployment complete!"

      - name: Check PM2 Status After Deploy
        if: always()
        run: |
          echo "üîç Checking PM2 status..."
          pm2 status
