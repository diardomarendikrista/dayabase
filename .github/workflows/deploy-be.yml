name: Deploy dayabase-be

on:
  push:
    branches: [main]
    paths:
      - "dayabase-be/**"
      - ".github/workflows/deploy-be.yml"

jobs:
  deploy-be:
    runs-on: self-hosted

    steps:
      - name: 1. Fetch Latest Code
        # Menjalankan perintah di dalam direktori proyek utama
        working-directory: /home/ec2-user/dayabase
        run: |
          echo "Fetching latest code from main branch..."
          git fetch --all
          git reset --hard origin/main
          echo "Code updated!"

      - name: 2. Install Dependencies
        # Pindah ke direktori backend untuk instalasi
        working-directory: /home/ec2-user/dayabase/dayabase-be
        run: |
          echo "Installing Node dependencies..."
          npm install
          echo "Dependencies installed!"

      - name: 3. Reload PM2 Service
        # Kembali ke direktori utama di mana file ecosystem berada
        working-directory: /home/ec2-user/dayabase
        run: |
          echo "Reloading PM2 service: app..."
          pm2 reload ecosystem.config.js --only app
          echo "Service 'app' reloaded!"

      - name: 4. Check PM2 Status After Deploy
        # Selalu jalankan langkah ini untuk verifikasi, bahkan jika langkah sebelumnya gagal
        if: always()
        run: |
          echo "Checking PM2 status..."
          pm2 status
